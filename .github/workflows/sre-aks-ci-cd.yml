  name: Full DevOps Pipeline

  on:
    push:
      branches:
        - main

  env:
    IMAGE_NAME: 7kishore/konguxguvi
    CLUSTER_NAME: kumar-eks
    REGION: ${{ secrets.AWS_REGION }}
    NAMESPACE: myapp
    DEPLOYMENT_NAME: myapp

  jobs:

  # ==========================================
  # STAGE 1 ‚Äì TEST
  # ==========================================
    test:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: 18
            cache: 'npm'
            cache-dependency-path: package-lock.json

        - name: Install dependencies
          run: 
            npm ci

        - name: Run tests
          run: |
            cd app
            echo "No tests configured yet"
            # npm test


  # ==========================================
  # STAGE 2 ‚Äì BUILD & PUSH IMAGE
  # ==========================================
    build:
      runs-on: ubuntu-latest
      needs: test

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Docker login
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Build and push Docker image
          uses: docker/build-push-action@v5
          with:
            context: .
            push: true
            tags: |
              ${{ env.IMAGE_NAME }}:latest
              ${{ env.IMAGE_NAME }}:${{ github.sha }}
            cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:latest
            cache-to: type=inline


  # ==========================================
  # STAGE 3 ‚Äì DEPLOY TO EKS (NO INFRA CHANGES)
  # ==========================================
    deploy:
      runs-on: ubuntu-latest
      needs: build

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: AWS Login
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ secrets.AWS_REGION }}

        - name: Install kubectl
          run: |
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
            kubectl version --client

        - name: Check if EKS cluster exists
          id: check_cluster
          run: |
            if aws eks describe-cluster --name $CLUSTER_NAME --region $REGION &> /dev/null; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "‚úÖ EKS cluster '$CLUSTER_NAME' exists"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
              echo "‚ùå EKS cluster '$CLUSTER_NAME' does not exist"
              echo "Please create the cluster first using Terraform locally or manually"
              exit 1
            fi

        - name: Connect to EKS Cluster
          run: |
            echo "Connecting to EKS cluster..."
            aws eks update-kubeconfig --name $CLUSTER_NAME --region $REGION
            
        - name: Verify cluster connection
          run: |
            echo "Verifying cluster connection..."
            kubectl cluster-info
            echo ""
            echo "Node status:"
            kubectl get nodes
            echo ""
            echo "‚úÖ Cluster connection successful!"

        - name: Create namespace
          run: |
            echo "Creating/verifying namespace: $NAMESPACE"
            kubectl apply -f k8s/namespace.yaml
            kubectl get namespace $NAMESPACE

        - name: Validate Kubernetes manifests
          run: |
            echo "Validating Kubernetes manifests..."
            kubectl apply --dry-run=client -f k8s/deployment.yaml
            kubectl apply --dry-run=client -f k8s/service.yaml
            kubectl apply --dry-run=client -f k8s/ingress.yaml
            echo "‚úÖ Manifests validation successful!"

        - name: Deploy application
          run: |
            echo "Deploying application to namespace: $NAMESPACE"
            kubectl apply -f k8s/deployment.yaml -n $NAMESPACE
            kubectl apply -f k8s/service.yaml -n $NAMESPACE

        - name: Wait for deployment to be ready
          run: |
            echo "Waiting for deployment to be ready..."
            kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE --timeout=5m

        - name: Update deployment with latest image
          run: |
            echo "Updating deployment with latest image: $IMAGE_NAME:${{ github.sha }}"
            kubectl set image deployment/$DEPLOYMENT_NAME \
              $DEPLOYMENT_NAME=$IMAGE_NAME:${{ github.sha }} \
              -n $NAMESPACE
            echo "Waiting for rollout to complete..."
            kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE --timeout=5m

        - name: Install/Verify Ingress Controller
          run: |
            echo "Checking for ingress-nginx controller..."
            if ! kubectl get namespace ingress-nginx &> /dev/null; then
              echo "Installing ingress-nginx controller..."
              kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.5/deploy/static/provider/cloud/deploy.yaml
              echo "Waiting for ingress controller to be ready..."
              kubectl wait --namespace ingress-nginx \
                --for=condition=ready pod \
                --selector=app.kubernetes.io/component=controller \
                --timeout=300s
            else
              echo "‚úÖ Ingress controller already installed"
            fi

        - name: Deploy ingress
          run: |
            echo "Deploying ingress..."
            kubectl apply -f k8s/ingress.yaml -n $NAMESPACE
            sleep 10

        - name: Get deployment status
          if: always()
          run: |
            echo "=========================================="
            echo "üìä DEPLOYMENT STATUS"
            echo "=========================================="
            kubectl get all -n $NAMESPACE
            echo ""
            echo "=========================================="
            echo "üåê INGRESS INFORMATION"
            echo "=========================================="
            kubectl get ingress -n $NAMESPACE -o wide || echo "No ingress found in namespace"
            echo ""
            echo "=========================================="
            echo "üîå INGRESS CONTROLLER SERVICE"
            echo "=========================================="
            kubectl get svc -n ingress-nginx || echo "Ingress controller not found"
            echo ""
            echo "=========================================="
            echo "üìù POD LOGS (Last 20 lines)"
            echo "=========================================="
            kubectl logs -n $NAMESPACE -l app=$DEPLOYMENT_NAME --tail=20 || echo "No logs available yet"

        - name: Show application endpoint
          run: |
            echo "=========================================="
            echo "üöÄ APPLICATION ENDPOINTS"
            echo "=========================================="
            INGRESS_HOST=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
            if [ -z "$INGRESS_HOST" ]; then
              INGRESS_HOST=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            fi
            
            if [ -n "$INGRESS_HOST" ] && [ "$INGRESS_HOST" != "pending" ]; then
              echo "‚úÖ LoadBalancer URL: http://$INGRESS_HOST"
              echo ""
              echo "üìù Note: It may take a few minutes for DNS to propagate"
            else
              echo "‚è≥ LoadBalancer is still being provisioned..."
              echo "Run this command to check status:"
              echo "kubectl get svc -n ingress-nginx ingress-nginx-controller"
            fi
            echo "=========================================="
